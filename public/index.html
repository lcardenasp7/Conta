<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión Escolar - I.E.D. Villas de San Pablo</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <i class="bi bi-mortarboard-fill"></i>
                </div>
                <h3>I.E.D. Villas de San Pablo</h3>
                <p>Sistema de Gestión Escolar</p>
            </div>
            <div class="login-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Correo Electrónico</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-lock"></i></span>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="remember">
                        <label class="form-check-label" for="remember">Recordar sesión</label>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-box-arrow-in-right"></i> Iniciar Sesión
                    </button>
                    <div class="text-center mt-3">
                        <a href="reset-password.html" class="text-decoration-none">
                            <i class="bi bi-key"></i> ¿Olvidaste tu contraseña?
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="main-container d-none">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="bi bi-mortarboard-fill"></i>
                    <span class="sidebar-title">Villas de San Pablo</span>
                </div>
                <button class="btn btn-link text-white d-md-none" onclick="toggleSidebar()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <nav class="sidebar-menu">
                <a href="#" class="menu-item active" data-page="dashboard">
                    <i class="bi bi-speedometer2"></i>
                    <span class="menu-text">Dashboard</span>
                </a>
                
                <div class="menu-section">
                    <div class="menu-item" onclick="toggleSubmenu('academic')">
                        <i class="bi bi-mortarboard"></i>
                        <span class="menu-text">Gestión Académica</span>
                        <i class="bi bi-chevron-down submenu-arrow"></i>
                    </div>
                    <div id="academic-submenu" class="submenu">
                        <a href="#" class="submenu-item" data-page="students">
                            <i class="bi bi-people"></i> Estudiantes
                        </a>
                        <a href="#" class="submenu-item" data-page="grades">
                            <i class="bi bi-card-list"></i> Grados y Grupos
                        </a>
                    </div>
                </div>

                <div class="menu-section">
                    <div class="menu-item" onclick="toggleSubmenu('billing')">
                        <i class="bi bi-receipt"></i>
                        <span class="menu-text">Facturación</span>
                        <i class="bi bi-chevron-down submenu-arrow"></i>
                    </div>
                    <div id="billing-submenu" class="submenu">
                        <a href="#" class="submenu-item" data-page="invoices">
                            <i class="bi bi-file-earmark-text"></i> Facturas
                        </a>
                        <a href="#" class="submenu-item" data-page="payments">
                            <i class="bi bi-cash-coin"></i> Pagos
                        </a>
                        <a href="#" class="submenu-item" data-page="debts">
                            <i class="bi bi-exclamation-triangle"></i> Control de Deudas
                        </a>
                        <a href="#" class="submenu-item" data-page="reports">
                            <i class="bi bi-graph-up"></i> Reportes Financieros
                        </a>
                    </div>
                </div>

                <!-- EVENTOS ESCOLARES - SECCIÓN ACTUALIZADA -->
                <div class="menu-section">
                    <div class="menu-item" onclick="toggleSubmenu('events')">
                        <i class="bi bi-calendar-event"></i>
                        <span class="menu-text">Eventos Escolares</span>
                        <i class="bi bi-chevron-down submenu-arrow"></i>
                    </div>
                    <div id="events-submenu" class="submenu">
                        <a href="#" class="submenu-item" data-page="events">
                            <i class="bi bi-calendar-plus"></i> Gestión de Eventos
                        </a>
                        <a href="#" class="submenu-item" data-page="event-assignments">
                            <i class="bi bi-person-check"></i> Asignaciones
                        </a>
                        <a href="#" class="submenu-item" data-page="event-reports">
                            <i class="bi bi-bar-chart"></i> Reportes de Eventos
                        </a>
                    </div>
                </div>

                <a href="#" class="menu-item" data-page="reports">
                    <i class="bi bi-file-earmark-pdf"></i>
                    <span class="menu-text">Reportes</span>
                </a>

                <div class="menu-section">
                    <div class="menu-item" onclick="toggleSubmenu('settings')">
                        <i class="bi bi-gear"></i>
                        <span class="menu-text">Configuración</span>
                        <i class="bi bi-chevron-down submenu-arrow"></i>
                    </div>
                    <div id="settings-submenu" class="submenu">
                        <a href="#" class="submenu-item" data-page="users">
                            <i class="bi bi-people-fill"></i> Usuarios
                        </a>
                        <a href="#" class="submenu-item" data-page="institution">
                            <i class="bi bi-building"></i> Institución
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main id="mainContent" class="main-content">
            <!-- Top Navbar -->
            <nav class="top-navbar">
                <div class="d-flex align-items-center">
                    <button class="btn btn-link d-md-none me-2" onclick="toggleSidebar()">
                        <i class="bi bi-list"></i>
                    </button>
                    <h4 id="pageTitle" class="mb-0">Dashboard</h4>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                            <span id="userName">Usuario</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                            </a></li>
                        </ul>
                    </div>
                </div>
            </nav>

            <!-- Content Area -->
            <div id="contentArea" class="content-area">
                <!-- Content will be loaded here dynamically -->
            </div>
        </main>
    </div>

    <!-- Student Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="studentModalTitle">Estudiante</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="studentForm">
                        <input type="hidden" id="editStudentId" name="studentId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="documentType" class="form-label">Tipo de Documento</label>
                                    <select class="form-select" id="documentType" name="documentType" required>
                                        <option value="">Seleccionar</option>
                                        <option value="TI">Tarjeta de Identidad</option>
                                        <option value="RC">Registro Civil</option>
                                        <option value="CC">Cédula de Ciudadanía</option>
                                        <option value="CE">Cédula de Extranjería</option>
                                        <option value="PP">Pasaporte</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="document" class="form-label">Número de Documento</label>
                                    <input type="text" class="form-control" id="document" name="document" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="firstName" class="form-label">Nombres</label>
                                    <input type="text" class="form-control" id="firstName" name="firstName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="lastName" class="form-label">Apellidos</label>
                                    <input type="text" class="form-control" id="lastName" name="lastName" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="birthDate" class="form-label">Fecha de Nacimiento</label>
                                    <input type="date" class="form-control" id="birthDate" name="birthDate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="gender" class="form-label">Género</label>
                                    <select class="form-select" id="gender" name="gender" required>
                                        <option value="">Seleccionar</option>
                                        <option value="M">Masculino</option>
                                        <option value="F">Femenino</option>
                                        <option value="O">Otro</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="studentEmail" name="email">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Teléfono</label>
                                    <input type="tel" class="form-control" id="phone" name="phone" pattern="[0-9]{7,15}" title="Ingrese un número de teléfono válido (7-15 dígitos)">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="address" name="address" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="gradeId" class="form-label">Grado</label>
                                    <select class="form-select" id="gradeId" name="gradeId" required>
                                        <option value="">Seleccionar grado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="groupId" class="form-label">Grupo</label>
                                    <select class="form-select" id="groupId" name="groupId" required>
                                        <option value="">Seleccionar grupo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="guardianName" class="form-label">Nombre del Acudiente</label>
                                    <input type="text" class="form-control" id="guardianName" name="guardianName">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="guardianPhone" class="form-label">Teléfono del Acudiente</label>
                                    <input type="tel" class="form-control" id="guardianPhone" name="guardianPhone" pattern="[0-9]{7,15}" title="Ingrese un número de teléfono válido (7-15 dígitos)">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="guardianEmail" class="form-label">Email del Acudiente</label>
                                    <input type="email" class="form-control" id="guardianEmail" name="guardianEmail">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">Estado</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="ACTIVE">Activo</option>
                                <option value="INACTIVE">Inactivo</option>
                                <option value="GRADUATED">Graduado</option>
                                <option value="TRANSFERRED">Trasladado</option>
                                <option value="SUSPENDED">Suspendido</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveStudentBtn" onclick="saveStudent()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal fade" id="invoiceModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="invoiceModalTitle">Factura</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="invoiceForm">
                        <input type="hidden" id="invoiceId" name="invoiceId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentSearch" class="form-label">Buscar Estudiante</label>
                                    <input type="text" class="form-control" id="studentSearch" placeholder="Escriba el nombre o documento...">
                                    <input type="hidden" id="studentId" name="studentId" required>
                                    <div id="studentSearchResults" class="list-group mt-1"></div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="concept" class="form-label">Concepto</label>
                                    <select class="form-select" id="concept" name="concept" required>
                                        <option value="">Seleccionar</option>
                                        <option value="TUITION">Matrícula</option>
                                        <option value="MONTHLY">Mensualidad</option>
                                        <option value="EVENT">Evento Escolar</option>
                                        <option value="UNIFORM">Uniforme</option>
                                        <option value="BOOKS">Libros</option>
                                        <option value="TRANSPORT">Transporte</option>
                                        <option value="CAFETERIA">Cafetería</option>
                                        <option value="OTHER">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="dueDate" class="form-label">Fecha de Vencimiento</label>
                                    <input type="date" class="form-control" id="dueDate" name="dueDate" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6>Items de la Factura</h6>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="addInvoiceItem()">
                                    <i class="bi bi-plus"></i> Agregar Item
                                </button>
                            </div>
                            <div id="invoiceItems" class="mt-3"></div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="observations" class="form-label">Observaciones</label>
                                    <textarea class="form-control" id="observations" name="observations" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <span>Subtotal:</span>
                                            <span id="invoiceSubtotal">$0</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>IVA:</span>
                                            <span id="invoiceTax">$0</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between fw-bold">
                                            <span>Total:</span>
                                            <span id="invoiceTotal">$0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveInvoiceBtn" onclick="saveInvoice()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalTitle">Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="paymentId" name="paymentId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="studentSearchPayment" class="form-label">Buscar Estudiante</label>
                                    <input type="text" class="form-control" id="studentSearchPayment" placeholder="Escriba el nombre o documento...">
                                    <input type="hidden" id="paymentStudentId" name="studentId" required>
                                    <div id="studentSearchResultsPayment" class="list-group mt-1"></div>
                                    <div id="paymentStudentInfo" class="mt-2"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="paymentInvoiceId" class="form-label">Factura (Opcional)</label>
                                    <select class="form-select" id="paymentInvoiceId" name="invoiceId">
                                        <option value="">Sin factura asociada</option>
                                    </select>
                                    <div id="paymentInvoiceInfo" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="paymentAmount" class="form-label">Monto</label>
                                    <input type="number" class="form-control" id="paymentAmount" name="amount" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="paymentMethod" class="form-label">Método de Pago</label>
                                    <select class="form-select" id="paymentMethod" name="method" required>
                                        <option value="">Seleccionar</option>
                                        <option value="CASH">Efectivo</option>
                                        <option value="BANK_TRANSFER">Transferencia</option>
                                        <option value="CARD">Tarjeta</option>
                                        <option value="CHECK">Cheque</option>
                                        <option value="OTHER">Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="paymentDate" class="form-label">Fecha</label>
                                    <input type="date" class="form-control" id="paymentDate" name="date" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="paymentReference" class="form-label">Referencia</label>
                            <input type="text" class="form-control" id="paymentReference" name="reference" placeholder="Número de transacción, cheque, etc.">
                        </div>
                        <div class="mb-3">
                            <label for="paymentObservations" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="paymentObservations" name="observations" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="savePaymentBtn" onclick="savePayment()">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Invoice Modal -->
    <div class="modal fade" id="bulkInvoiceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Facturación Masiva</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkInvoiceForm">
                        <div class="mb-3">
                            <label for="bulkGradeId" class="form-label">Grado</label>
                            <select class="form-select" id="bulkGradeId" name="gradeId" required>
                                <option value="">Seleccionar grado</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="bulkConcept" class="form-label">Concepto</label>
                            <select class="form-select" id="bulkConcept" name="concept" required>
                                <option value="">Seleccionar</option>
                                <option value="TUITION">Matrícula</option>
                                <option value="MONTHLY">Mensualidad</option>
                                <option value="EVENT">Evento Escolar</option>
                                <option value="UNIFORM">Uniforme</option>
                                <option value="BOOKS">Libros</option>
                                <option value="TRANSPORT">Transporte</option>
                                <option value="CAFETERIA">Cafetería</option>
                                <option value="OTHER">Otro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="bulkDescription" class="form-label">Descripción</label>
                            <input type="text" class="form-control" id="bulkDescription" name="description" required>
                        </div>
                        <div class="mb-3">
                            <label for="bulkAmount" class="form-label">Monto</label>
                            <input type="number" class="form-control" id="bulkAmount" name="amount" min="0" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="bulkDueDate" class="form-label">Fecha de Vencimiento</label>
                            <input type="date" class="form-control" id="bulkDueDate" name="dueDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="createBulkInvoices()">Crear Facturas</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom Scripts -->
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/students.js"></script>
    <script src="js/invoices.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/payments.js"></script>
    <script src="js/debts.js"></script>
    <script src="js/grades.js"></script>
    <script src="js/institution.js"></script>
    <script src="js/modal-accessibility.js"></script>
    
    <!-- MÓDULOS DE EVENTOS REFACTORIZADOS -->
    <script src="js/events-core.js"></script>
    <script src="js/event-assignments.js"></script>
    <script src="js/event-reports.js"></script>
    <script src="js/events.js"></script>
    
    <!-- Scripts de prueba -->
    <script src="test-simple.js"></script>
    <script src="test-student-search.js"></script>
</body>
</html>