<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug de Fondos - Railway</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .result-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .btn-debug {
            margin: 5px;
        }
        .loading {
            display: none;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">üîß Debug de Fondos - Railway</h1>
                <p class="text-muted">Herramientas para diagnosticar y solucionar problemas con los fondos en producci√≥n.</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üîç Diagn√≥stico</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary btn-debug" onclick="checkDatabase()">
                            Verificar Base de Datos
                        </button>
                        <button class="btn btn-info btn-debug" onclick="diagnoseFunds()">
                            Diagnosticar Fondos
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üèóÔ∏è Acciones</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success btn-debug" onclick="createSampleFunds()">
                            Crear Fondos de Ejemplo
                        </button>
                        <button class="btn btn-warning btn-debug" onclick="createSampleFunds(true)">
                            Recrear Fondos (Limpiar + Crear)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>üìã Resultados</h5>
                        <div class="loading">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            Procesando...
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="results" class="result-box">
                            Haz clic en cualquier bot√≥n para ver los resultados aqu√≠...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h6>‚ÑπÔ∏è Instrucciones:</h6>
                    <ul class="mb-0">
                        <li><strong>Verificar Base de Datos:</strong> Comprueba la conexi√≥n a PostgreSQL</li>
                        <li><strong>Diagnosticar Fondos:</strong> Revisa el estado actual de los fondos</li>
                        <li><strong>Crear Fondos de Ejemplo:</strong> Crea fondos de prueba si no existen</li>
                        <li><strong>Recrear Fondos:</strong> Elimina todos los fondos existentes y crea nuevos</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = window.location.origin;
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.querySelector('.loading');

        // Funci√≥n para obtener el token de autenticaci√≥n
        function getAuthToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        // Funci√≥n para mostrar resultados
        function showResults(data) {
            if (typeof data === 'object') {
                resultsDiv.textContent = JSON.stringify(data, null, 2);
            } else {
                resultsDiv.textContent = data;
            }
        }

        // Funci√≥n para mostrar loading
        function showLoading(show = true) {
            loadingDiv.style.display = show ? 'flex' : 'none';
        }

        // Funci√≥n para hacer peticiones a la API
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const token = getAuthToken();
            
            if (!token) {
                showResults('‚ùå Error: No se encontr√≥ token de autenticaci√≥n.\n\nPor favor, inicia sesi√≥n primero en el sistema principal.');
                return;
            }

            showLoading(true);
            
            try {
                const options = {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}/api/debug${endpoint}`, options);
                const data = await response.json();

                if (response.ok) {
                    showResults(`‚úÖ √âxito: ${data.message}\n\n${JSON.stringify(data.data, null, 2)}`);
                } else {
                    showResults(`‚ùå Error: ${data.error}\n\nDetalles: ${data.details || 'No disponibles'}`);
                }
            } catch (error) {
                showResults(`üí• Error de conexi√≥n: ${error.message}\n\nVerifica que el servidor est√© funcionando.`);
            } finally {
                showLoading(false);
            }
        }

        // Funciones de debug
        async function checkDatabase() {
            await apiRequest('/database');
        }

        async function diagnoseFunds() {
            await apiRequest('/funds');
        }

        async function createSampleFunds(clearExisting = false) {
            await apiRequest('/create-sample-funds', 'POST', { clearExisting });
        }

        // Verificar autenticaci√≥n al cargar la p√°gina
        window.addEventListener('load', () => {
            const token = getAuthToken();
            if (!token) {
                showResults('‚ö†Ô∏è Advertencia: No se detect√≥ token de autenticaci√≥n.\n\nPara usar estas herramientas:\n1. Ve al sistema principal\n2. Inicia sesi√≥n\n3. Regresa a esta p√°gina\n\nO puedes continuar, pero las peticiones fallar√°n.');
            } else {
                showResults('üîë Token de autenticaci√≥n detectado.\n\n¬°Listo para usar las herramientas de debug!');
            }
        });
    </script>
</body>
</html>