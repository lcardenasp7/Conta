const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();

async function cleanTestStudents() {
    console.log('üßπ LIMPIANDO ESTUDIANTES DE PRUEBA');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    try {
        // 1. Primero, identificar estudiantes de prueba
        console.log('üîç Identificando estudiantes de prueba...');
        
        const testStudents = await prisma.student.findMany({
            where: {
                OR: [
                    { firstName: { startsWith: 'Estudiante' } },
                    { email: { contains: 'estudiante' } },
                    { document: { gte: '1000000001', lte: '1000000050' } },
                    { firstName: { contains: 'Estudiante' } },
                    { lastName: { contains: 'Apellido' } }
                ]
            },
            select: {
                id: true,
                document: true,
                firstName: true,
                lastName: true,
                email: true
            }
        });
        
        console.log(`üìä Estudiantes de prueba encontrados: ${testStudents.length}`);
        
        if (testStudents.length === 0) {
            console.log('‚úÖ No hay estudiantes de prueba para eliminar');
            return;
        }
        
        // Mostrar los estudiantes que se van a eliminar
        console.log('\nüë• ESTUDIANTES A ELIMINAR:');
        testStudents.slice(0, 10).forEach(s => {
            console.log(`  - ${s.firstName} ${s.lastName} (${s.document}) - ${s.email}`);
        });
        if (testStudents.length > 10) {
            console.log(`  ... y ${testStudents.length - 10} m√°s`);
        }
        
        // 2. Eliminar registros relacionados primero
        const testStudentIds = testStudents.map(s => s.id);
        
        console.log('\nüóëÔ∏è Eliminando registros relacionados...');
        
        // Eliminar asistencias
        const deletedAttendances = await prisma.attendance.deleteMany({
            where: { studentId: { in: testStudentIds } }
        });
        console.log(`  ‚úÖ Asistencias eliminadas: ${deletedAttendances.count}`);
        
        // Eliminar inscripciones
        const deletedEnrollments = await prisma.enrollment.deleteMany({
            where: { studentId: { in: testStudentIds } }
        });
        console.log(`  ‚úÖ Inscripciones eliminadas: ${deletedEnrollments.count}`);
        
        // Eliminar asignaciones de eventos
        const deletedEventAssignments = await prisma.eventAssignment.deleteMany({
            where: { studentId: { in: testStudentIds } }
        });
        console.log(`  ‚úÖ Asignaciones de eventos eliminadas: ${deletedEventAssignments.count}`);
        
        // Eliminar transacciones de fondos relacionadas con pagos/facturas de estos estudiantes
        console.log('üóëÔ∏è Eliminando transacciones de fondos relacionadas...');
        await prisma.fundTransaction.deleteMany({
            where: {
                OR: [
                    { Payment: { studentId: { in: testStudentIds } } },
                    { Invoice: { studentId: { in: testStudentIds } } }
                ]
            }
        });
        
        // Eliminar pagos
        const deletedPayments = await prisma.payment.deleteMany({
            where: { studentId: { in: testStudentIds } }
        });
        console.log(`  ‚úÖ Pagos eliminados: ${deletedPayments.count}`);
        
        // Eliminar √≠tems de facturas relacionadas
        await prisma.invoiceItem.deleteMany({
            where: {
                invoice: { studentId: { in: testStudentIds } }
            }
        });
        
        // Eliminar facturas
        const deletedInvoices = await prisma.invoice.deleteMany({
            where: { studentId: { in: testStudentIds } }
        });
        console.log(`  ‚úÖ Facturas eliminadas: ${deletedInvoices.count}`);
        
        // 3. Finalmente eliminar estudiantes
        console.log('\nüë®‚Äçüéì Eliminando estudiantes de prueba...');
        const deletedStudents = await prisma.student.deleteMany({
            where: { id: { in: testStudentIds } }
        });
        
        console.log(`‚úÖ √âXITO: ${deletedStudents.count} estudiantes de prueba eliminados`);
        
        // 4. Verificar resultado
        const remainingStudents = await prisma.student.count();
        console.log(`üë• Estudiantes restantes: ${remainingStudents}`);
        
        // 5. Mostrar estad√≠sticas por grado despu√©s de la limpieza
        console.log('\nüìä ESTAD√çSTICAS ACTUALIZADAS:');
        const stats = await prisma.grade.findMany({
            include: {
                _count: { select: { students: true } }
            },
            orderBy: { order: 'asc' }
        });
        
        stats.forEach(grade => {
            if (grade._count.students > 0) {
                console.log(`  ${grade.name}: ${grade._count.students} estudiantes`);
            }
        });
        
    } catch (error) {
        console.error('‚ùå Error limpiando estudiantes de prueba:', error);
        
        // Si hay error de constraint, intentar con m√©todo m√°s espec√≠fico
        if (error.code === 'P2003') {
            console.log('\nüîß Reintentando con m√©todo espec√≠fico...');
            await cleanWithSpecificMethod();
        }
    } finally {
        await prisma.$disconnect();
    }
}

async function cleanWithSpecificMethod() {
    try {
        // M√©todo m√°s espec√≠fico para casos complicados
        console.log('üîß Usando m√©todo espec√≠fico para eliminar estudiantes de prueba...');
        
        // Obtener IDs de estudiantes de prueba
        const testStudentIds = await prisma.student.findMany({
            where: {
                OR: [
                    { firstName: { startsWith: 'Estudiante' } },
                    { document: { gte: '1000000001', lte: '1000000050' } }
                ]
            },
            select: { id: true }
        }).then(students => students.map(s => s.id));
        
        if (testStudentIds.length === 0) {
            console.log('‚úÖ No hay estudiantes de prueba para eliminar');
            return;
        }
        
        // Eliminar uno por uno para evitar problemas de constraints
        for (const studentId of testStudentIds) {
            try {
                // Eliminar todas las relaciones del estudiante
                await prisma.attendance.deleteMany({
                    where: { studentId }
                });
                
                await prisma.enrollment.deleteMany({
                    where: { studentId }
                });
                
                await prisma.eventAssignment.deleteMany({
                    where: { studentId }
                });
                
                // Eliminar transacciones relacionadas con este estudiante
                await prisma.fundTransaction.deleteMany({
                    where: {
                        OR: [
                            { Payment: { studentId } },
                            { Invoice: { studentId } }
                        ]
                    }
                });
                
                await prisma.payment.deleteMany({
                    where: { studentId }
                });
                
                await prisma.invoiceItem.deleteMany({
                    where: { invoice: { studentId } }
                });
                
                await prisma.invoice.deleteMany({
                    where: { studentId }
                });
                
                // Finalmente eliminar el estudiante
                await prisma.student.delete({
                    where: { id: studentId }
                });
                
            } catch (err) {
                console.log(`‚ö†Ô∏è No se pudo eliminar estudiante ${studentId}: ${err.message}`);
            }
        }
        
        console.log('‚úÖ Limpieza espec√≠fica completada');
        
    } catch (error) {
        console.error('‚ùå Error en m√©todo espec√≠fico:', error);
    }
}

async function cleanEmptyGroups() {
    console.log('\nüßπ LIMPIANDO GRUPOS VAC√çOS DEL SEED');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    try {
        // Encontrar grupos sin estudiantes que tengan formato "01", "02", etc.
        const emptyGroups = await prisma.group.findMany({
            where: {
                AND: [
                    { students: { none: {} } }, // Sin estudiantes
                    { name: { in: ['01', '02', '03', '04', '05', '06'] } } // Solo grupos del seed
                ]
            },
            include: {
                grade: true,
                _count: { select: { students: true } }
            }
        });
        
        console.log(`üìä Grupos vac√≠os del seed encontrados: ${emptyGroups.length}`);
        
        if (emptyGroups.length > 0) {
            console.log('\nüóëÔ∏è GRUPOS A ELIMINAR:');
            emptyGroups.forEach(group => {
                console.log(`  - ${group.grade.name} - Grupo ${group.name} (${group._count.students} estudiantes)`);
            });
            
            const deletedGroups = await prisma.group.deleteMany({
                where: {
                    id: { in: emptyGroups.map(g => g.id) }
                }
            });
            
            console.log(`‚úÖ ${deletedGroups.count} grupos vac√≠os eliminados`);
        } else {
            console.log('‚úÖ No hay grupos vac√≠os del seed para eliminar');
        }
        
    } catch (error) {
        console.error('‚ùå Error limpiando grupos vac√≠os:', error);
    }
}

// Funci√≥n principal
async function main() {
    const command = process.argv[2];
    
    switch (command) {
        case 'students':
            await cleanTestStudents();
            break;
        case 'groups':
            await cleanEmptyGroups();
            break;
        case 'all':
            await cleanTestStudents();
            await cleanEmptyGroups();
            break;
        default:
            console.log('üßπ SCRIPT DE LIMPIEZA');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('Comandos:');
            console.log('  node clean-test-students.js students - Limpiar estudiantes de prueba');
            console.log('  node clean-test-students.js groups   - Limpiar grupos vac√≠os del seed');
            console.log('  node clean-test-students.js all      - Limpiar todo (recomendado)');
            break;
    }
}

if (require.main === module) {
    main().catch(console.error);
}

module.exports = {
    cleanTestStudents,
    cleanEmptyGroups
};